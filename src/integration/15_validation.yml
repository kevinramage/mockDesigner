name: Validation
vars:
  host: "localhost"
  port: 7015
  output: generated_validation_1
testcases:

# Build mock
- name: BuildMockService
  steps:
  - type: exec
    script: npm run start -- --input tests/code/examples/validation.yml --port {{.port}} --output {{.output}}
    assertions:
    - result.code ShouldEqual 0
  - type: exec
    script: docker-compose -f {{.output}}/docker-compose.yml up -d --force-recreate --build
  - type: exec
    script: ./wait {{.output}}_was_1
  - type: http
    method: GET
    url: "http://{{.host}}:{{.port}}/api/v1/validationService/_ping"
    assertions:
    - result.statuscode ShouldEqual 204

# Check mandatories fields
- name: CheckMandatoriesFields
  steps:
  - type: http
    method: POST
    url: "http://{{.host}}:{{.port}}/api/v1/sendToDelivery"
    headers:
      Content-Type: application/json
    body: "{}"
    assertions:
    - result.statuscode ShouldEqual 400
    - result.body ShouldEqual "Mandatories fields missing deliveryDate, products"
  - type: http
    method: POST
    url: "http://{{.host}}:{{.port}}/api/v1/sendToDelivery"
    headers:
      Content-Type: application/json
    body: "{ \"deliveryDate\": \"20200528\", \"contact\": {}, \"products\": [] }"
    assertions:
    - result.statuscode ShouldEqual 400
    - result.body ShouldEqual "Mandatories fields missing contact.id"
  - type: http
    method: POST
    url: "http://{{.host}}:{{.port}}/api/v1/sendToDelivery"
    headers:
      Content-Type: application/json
    body: "{ \"deliveryDate\": \"20200528\", \"contact\": {}, \"products\": [ { \"description\": \"coucou\" } ] }"
    assertions:
    - result.statuscode ShouldEqual 400
    - result.body ShouldEqual "Mandatories fields missing contact.id, products[0].id, products[0].name"
  - type: http
    method: POST
    url: "http://{{.host}}:{{.port}}/api/v1/sendToDelivery"
    headers:
      Content-Type: application/json
    body: "{ \"deliveryDate\": \"20200528\", \"products\": [ { \"id\": \"PRD_101\", \"name\": \"MyProduct\", \"description\": \"coucou\" }, {  \"id\": \"PRD_102\", \"description\": \"coucou\" } ] }"
    assertions:
    - result.statuscode ShouldEqual 400
    - result.body ShouldEqual "Mandatories fields missing products[1].name"

# Check types