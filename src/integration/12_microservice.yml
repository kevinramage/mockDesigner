name: Microservice
vars:
  host: "localhost"
  port: 7012
  output: generated_microservice
testcases:

# Build mock
- name: BuildMockService
  steps:
  - type: exec
    script: npm run start -- --input mocks/code/examples/microservice.yml --port {{.port}} --output {{.output}}
    assertions:
    - result.code ShouldEqual 0
  - type: exec
    script: docker-compose -f {{.output}}/docker-compose.yml up -d --force-recreate 
  - type: exec
    script: ./wait {{.output}}_was_1
  - type: http
    method: GET
    url: "http://{{.host}}:{{.port}}/api/v1/GetCommand/_ping"
    assertions:
    - result.statuscode ShouldEqual 204

# Clean database values
- name: CleanDatabaseValues
  steps:

  # Clean counter
  - type: http
    method: DELETE
    url: "http://{{.host}}:{{.port}}/api/v1/_deleteDatabaseValue?name=command"
    assertions:
    - result.statuscode ShouldEqual 204
  - type: http
    method: DELETE
    url: "http://{{.host}}:{{.port}}/api/v1/_deleteDatabaseValue?name=composed$$command2$$product"
    assertions:
    - result.statuscode ShouldEqual 204

  ## Clean data
  - type: http
    method: DELETE
    url: "http://{{.host}}:{{.port}}/api/v1/_deleteDatabaseValue?name=command.1"
    assertions:
    - result.statuscode ShouldEqual 204
  - type: http
    method: DELETE
    url: "http://{{.host}}:{{.port}}/api/v1/_deleteDatabaseValue?name=command.2"
    assertions:
    - result.statuscode ShouldEqual 204
  - type: http
    method: DELETE
    url: "http://{{.host}}:{{.port}}/api/v1/_deleteDatabaseValue?name=product.1"
    assertions:
    - result.statuscode ShouldEqual 204
  - type: http
    method: DELETE
    url: "http://{{.host}}:{{.port}}/api/v1/_deleteDatabaseValue?name=product.2"
    assertions:
    - result.statuscode ShouldEqual 204

# Test command creation
- name: TestCommandCreation
  steps:
  - type: http
    method: GET
    url: "http://{{.host}}:{{.port}}/api/v1/command"
    assertions:
    - result.statuscode ShouldEqual 200
    - result.body ShouldEqual []
  - type: http
    method: GET
    url: "http://{{.host}}:{{.port}}/api/v1/command/1"
    assertions:
    - result.statuscode ShouldEqual 404
  - type: http
    method: POST
    url: "http://{{.host}}:{{.port}}/api/v1/command"
    headers:
      Content-Type: application/json
    body: "{ \"name\": \"MyCommand\", \"description\": \"MyDescription\" }"
    assertions:
    - result.statuscode ShouldEqual 201
    - result.bodyjson.commandid ShouldEqual 1
    - result.bodyjson.name ShouldEqual MyCommand
    - result.bodyjson.description ShouldEqual MyDescription
  - type: http
    method: GET
    url: "http://{{.host}}:{{.port}}/api/v1/command/1"
    assertions:
    - result.statuscode ShouldEqual 200
    - result.bodyjson.commandid ShouldEqual 1
    - result.bodyjson.name ShouldEqual MyCommand
    - result.bodyjson.description ShouldEqual MyDescription
  - type: http
    method: GET
    url: "http://{{.host}}:{{.port}}/api/v1/command"
    assertions:
    - result.statuscode ShouldEqual 200
    - result.bodyjson.__len__ ShouldEqual 1
    - result.bodyjson.bodyjson0.commandid ShouldEqual 1
    - result.bodyjson.bodyjson0.name ShouldEqual MyCommand
    - result.bodyjson.bodyjson0.description ShouldEqual MyDescription
  - type: http
    method: POST
    url: "http://{{.host}}:{{.port}}/api/v1/command"
    headers:
      Content-Type: application/json
    body: "{ \"name\": \"MyCommand2\", \"description\": \"MyDescription2\" }"
    assertions:
    - result.statuscode ShouldEqual 201
    - result.bodyjson.commandid ShouldEqual 2
    - result.bodyjson.name ShouldEqual MyCommand2
    - result.bodyjson.description ShouldEqual MyDescription2
  - type: http
    method: GET
    url: "http://{{.host}}:{{.port}}/api/v1/command"
    assertions:
    - result.statuscode ShouldEqual 200
    - result.bodyjson.__len__ ShouldEqual 2
    - result.bodyjson.bodyjson0.commandid ShouldEqual 1
    - result.bodyjson.bodyjson0.name ShouldEqual MyCommand
    - result.bodyjson.bodyjson0.description ShouldEqual MyDescription
    - result.bodyjson.bodyjson1.commandid ShouldEqual 2
    - result.bodyjson.bodyjson1.name ShouldEqual MyCommand2
    - result.bodyjson.bodyjson1.description ShouldEqual MyDescription2

# Test command update
- name: TestCommandUpdate
  steps:
  - type: http
    method: PUT
    url: "http://{{.host}}:{{.port}}/api/v1/command/2"
    headers:
      Content-Type: application/json
    body: "{ \"commandId\": 2, \"name\": \"MyCommand2Updated\", \"description\": \"MyDescription2Updated\" }"
    assertions:
    - result.statuscode ShouldEqual 200
    - result.bodyjson.commandid ShouldEqual 2
    - result.bodyjson.name ShouldEqual MyCommand2Updated
    - result.bodyjson.description ShouldEqual MyDescription2Updated
  - type: http
    method: GET
    url: "http://{{.host}}:{{.port}}/api/v1/command/2"
    assertions:
    - result.statuscode ShouldEqual 200
    - result.bodyjson.commandid ShouldEqual 2
    - result.bodyjson.name ShouldEqual MyCommand2Updated
    - result.bodyjson.description ShouldEqual MyDescription2Updated

# Test command deletion
- name: TestCommandDeletion
  steps:
  - type: http
    method: DELETE
    url: "http://{{.host}}:{{.port}}/api/v1/command/1"
    assertions:
    - result.statuscode ShouldEqual 204
  - type: http
    method: GET
    url: "http://{{.host}}:{{.port}}/api/v1/command/1"
    assertions:
    - result.statuscode ShouldEqual 404
  - type: http
    method: GET
    url: "http://{{.host}}:{{.port}}/api/v1/command"
    assertions:
    - result.statuscode ShouldEqual 200
    - result.bodyjson.__len__ ShouldEqual 1
    - result.bodyjson.bodyjson0.commandid ShouldEqual 2
    - result.bodyjson.bodyjson0.name ShouldEqual MyCommand2Updated
    - result.bodyjson.bodyjson0.description ShouldEqual MyDescription2Updated

  # Test product creation
- name: TestProductCreation
  steps:
  - type: http
    method: GET
    url: "http://{{.host}}:{{.port}}/api/v1/command/2/product"
    assertions:
    - result.statuscode ShouldEqual 200
    - result.body ShouldEqual []
  - type: http
    method: GET
    url: "http://{{.host}}:{{.port}}/api/v1/command/2/product/1"
    assertions:
    - result.statuscode ShouldEqual 404
  - type: http
    method: POST
    url: "http://{{.host}}:{{.port}}/api/v1/command/2/product"
    headers:
      Content-Type: application/json
    body: "{ \"name\": \"MyProduct\", \"description\": \"MyDescription\" }"
    assertions:
    - result.statuscode ShouldEqual 201
    - result.bodyjson.productid ShouldEqual 1
    - result.bodyjson.name ShouldEqual MyProduct
    - result.bodyjson.description ShouldEqual MyDescription
  - type: http
    method: GET
    url: "http://{{.host}}:{{.port}}/api/v1/command/2/product"
    assertions:
    - result.statuscode ShouldEqual 200
    - result.bodyjson.__len__ ShouldEqual 1
    - result.bodyjson.bodyjson0.productid ShouldEqual 1
    - result.bodyjson.bodyjson0.name ShouldEqual MyProduct
    - result.bodyjson.bodyjson0.description ShouldEqual MyDescription
  - type: http
    method: GET
    url: "http://{{.host}}:{{.port}}/api/v1/command/2/product/1"
    assertions:
    - result.statuscode ShouldEqual 200
    - result.bodyjson.productid ShouldEqual 1
    - result.bodyjson.name ShouldEqual MyProduct
    - result.bodyjson.description ShouldEqual MyDescription
  - type: http
    method: POST
    url: "http://{{.host}}:{{.port}}/api/v1/command/2/product"
    headers:
      Content-Type: application/json
    body: "{ \"name\": \"MyProduct2\", \"description\": \"MyDescription2\" }"
    assertions:
    - result.statuscode ShouldEqual 201
    - result.bodyjson.productid ShouldEqual 2
    - result.bodyjson.name ShouldEqual MyProduct2
    - result.bodyjson.description ShouldEqual MyDescription2
  - type: http
    method: GET
    url: "http://{{.host}}:{{.port}}/api/v1/command/2/product"
    assertions:
    - result.statuscode ShouldEqual 200
    - result.bodyjson.__len__ ShouldEqual 2
    - result.bodyjson.bodyjson0.productid ShouldEqual 1
    - result.bodyjson.bodyjson0.name ShouldEqual MyProduct
    - result.bodyjson.bodyjson0.description ShouldEqual MyDescription
    - result.bodyjson.bodyjson1.productid ShouldEqual 2
    - result.bodyjson.bodyjson1.name ShouldEqual MyProduct2
    - result.bodyjson.bodyjson1.description ShouldEqual MyDescription2
  - type: http
    method: GET
    url: "http://{{.host}}:{{.port}}/api/v1/command/2/product/2"
    assertions:
    - result.statuscode ShouldEqual 200
    - result.bodyjson.productid ShouldEqual 2
    - result.bodyjson.name ShouldEqual MyProduct2
    - result.bodyjson.description ShouldEqual MyDescription2

# Test product update
- name: TestProductUpdate
  steps:
  - type: http
    method: PUT
    url: "http://{{.host}}:{{.port}}/api/v1/command/2/product/2"
    headers:
      Content-Type: application/json
    body: "{ \"productId\": 2, \"name\": \"MyProduct2Updated\", \"description\": \"MyDescription2Updated\" }"
    assertions:
    - result.statuscode ShouldEqual 200
    - result.bodyjson.productid ShouldEqual 2
    - result.bodyjson.name ShouldEqual MyProduct2Updated
    - result.bodyjson.description ShouldEqual MyDescription2Updated
  - type: http
    method: GET
    url: "http://{{.host}}:{{.port}}/api/v1/command/2/product/2"
    assertions:
    - result.statuscode ShouldEqual 200
    - result.bodyjson.productid ShouldEqual 2
    - result.bodyjson.name ShouldEqual MyProduct2Updated
    - result.bodyjson.description ShouldEqual MyDescription2Updated

# Test product deletion
- name: TestProductDeletion
  steps:
  - type: http
    method: DELETE
    url: "http://{{.host}}:{{.port}}/api/v1/command/2/product/1"
    assertions:
    - result.statuscode ShouldEqual 204
  - type: http
    method: GET
    url: "http://{{.host}}:{{.port}}/api/v1/command/2/product/1"
    assertions:
    - result.statuscode ShouldEqual 404
  - type: http
    method: GET
    url: "http://{{.host}}:{{.port}}/api/v1/command/2/product"
    assertions:
    - result.statuscode ShouldEqual 200
    - result.bodyjson.__len__ ShouldEqual 1
    - result.bodyjson.bodyjson0.productid ShouldEqual 2
    - result.bodyjson.bodyjson0.name ShouldEqual MyProduct2Updated
    - result.bodyjson.bodyjson0.description ShouldEqual MyDescription2Updated